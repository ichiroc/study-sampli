<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
  <title>ã‚¹ã‚¿ãƒ‡ã‚£ã‚µãƒ³ãƒ—ãƒª</title>
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#11409F">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ã‚µãƒ³ãƒ—ãƒª">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
</head>
<body class="bg-[#F4F7FC] flex flex-col h-dvh">
  <header class="bg-[#11409F] flex items-center justify-between px-4" style="height: calc(74px + env(safe-area-inset-top)); padding-top: env(safe-area-inset-top);">
    <span class="flex items-center gap-2">
      <span class="text-white text-2xl font-bold py-4">ã‚¹ã‚¿ãƒ‡ã‚£ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style='color: white;'>
        <path fill="currentColor" d="M12.05 17.625L9.225 20.45q-.575.575-1.412.575T6.4 20.45l-2.825-2.825Q3 17.05 3 16.2t.575-1.425l2.8-2.8V8.7q0-.675.613-.925T8.075 8l7.95 7.925q.475.475.213 1.088t-.938.612zm4.9-10.6q-1.475-1.475-3.462-1.9T9.6 5.4q-.375.125-.762-.012t-.513-.513q-.15-.425.025-.812t.6-.538q2.425-.9 4.975-.363t4.45 2.438t2.438 4.488t-.388 5.037q-.15.4-.55.563t-.8-.013q-.375-.15-.513-.525t.013-.775q.7-1.9.275-3.887t-1.9-3.463m-1.4 1.425q.55.55.862 1.238t.438 1.462q.05.4-.225.675t-.7.275q-.4 0-.687-.275t-.388-.675q-.1-.35-.262-.675t-.438-.6t-.625-.462t-.725-.288q-.4-.1-.687-.375t-.338-.7q-.05-.4.213-.7t.637-.25q.825.1 1.588.438t1.337.912"/>
      </svg>
    </span>
    <span class="text-[#CFE1FF] text-xs font-semibold">å­¦ç¿’ã‚µãƒãƒ¼ãƒˆ</span>
  </header>
  <div class="flex-1 flex justify-center">
    <div
      class="w-full max-w-[390px] flex flex-col"
      data-controller="count sound wakelock startup"
      data-action="keydown.a@window->sound#play keydown.a@window->count#push keydown.b@window->sound#play keydown.b@window->count#push"
    >

      <section class="bg-white px-4 pt-[18px] pb-[18px] flex flex-col gap-3">
        <h1 class="text-[#12377E] text-[42px] font-bold leading-[1.12]">æ­£è§£éŸ³ã§ã€<br>å‹‰å¼·ã®ãƒªã‚ºãƒ ã‚’<br>ã¤ãã‚ã†</h1>
        <p class="text-[#496182] text-lg leading-relaxed">å•é¡ŒãŒè§£ã‘ãŸã‚‰ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã ã‘â€¦</p>

        <div class="bg-[#0E3388] rounded-2xl h-[150px] flex items-center justify-center">

          <div class="bg-white w-[300px] rounded-xl p-[10px] flex flex-col gap-2">
            <div class="flex items-center justify-between h-[28px]">
              <span class="text-[#12377E] text-sm font-semibold">ä»Šæ—¥ã®æ­£è§£</span>
              <div class="flex items-center gap-1">
                <span
                  class="hidden bg-amber-200 text-red-500 text-xs font-bold px-2 py-0.5 rounded-full"
                  data-count-target="topBadge"
                >ğŸ”¥å‰å›è¶…ãˆï¼</span>
                <span
                  class="hidden bg-green-100 text-green-600 text-xs font-bold px-2 py-0.5 rounded-full"
                  data-count-target="goalBadge"
                >ğŸŠç›®æ¨™é”æˆï¼</span>
              </div>
            </div>
            <div class="bg-[#DCEEFF] rounded-lg h-[38px] flex items-center justify-between px-3">
              <span>
                <span class="text-[#12377E] text-sm font-medium">æ­£è§£ã‚«ã‚¦ãƒ³ãƒˆ</span>
                <span class="text-[#496182] text-xs">å‰å› <span data-count-target="prevCount">0</span></span>
              </span>
              <span class="flex items-center items-end gap-2">
                <span
                  class="text-[#D62FC6] text-xl font-bold"
                  data-count-target="count"
                >0</span>
              </span>
            </div>
            <div class="bg-[#F7FAFF] border border-[#D7DEEA] rounded-lg h-[38px] flex items-center justify-between px-3">
                <span
                  class="text-[#12377E] text-sm font-medium"
                  data-count-target="streakDays"
                >é€£ç¶š 0æ—¥</span>
                <span
                  class="text-[#496182] text-xs cursor-pointer underline"
                  data-count-target="streakSub"
                  data-action="click->count#editGoal"
                >ç›®æ¨™ã¾ã§ã‚ã¨20å•</span>
            </div>
          </div>
        </div>
      </section>

      <section class="bg-[#EAF4FF] flex-1 flex items-center justify-center relative" style="min-height: 310px;">
        <button
          data-action="click->sound#play click->count#push"
          data-count-target="button"
          class="w-[236px] h-[236px] rounded-full bg-[#18A8E4] text-white text-[58px] font-bold
                       active:scale-95 transition-all select-none shadow-lg"
        >
          æ­£è§£ï¼
        </button>
        <div class="flex justify-center color text-gray-500 text-sm absolute bottom-2">
          <div>â€»ã‚¸ãƒ§ãƒ¼ã‚¯ã‚¢ãƒ—ãƒªã§ã™</div>
        </div>
      </section>
      <div class="bg-white border-t border-[#E5EBF5] px-6 pt-3 pb-6 flex flex-col gap-1">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2 text-[#496182]">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
            </svg>
            <span class="text-sm font-medium">ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢</span>
          </div>
          <button
            data-action="click->wakelock#toggle"
            data-wakelock-target="toggle"
            role="switch"
            aria-checked="false"
            class="relative inline-flex h-[28px] w-[52px] flex-shrink-0 items-center rounded-full bg-gray-300 transition-colors duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#18A8E4]"
          >
            <span
              data-wakelock-target="knob"
              class="inline-block h-5 w-5 transform rounded-full bg-white shadow-md transition-transform duration-200 translate-x-1"
            ></span>
          </button>
        </div>
        <p data-wakelock-target="errorMsg" class="hidden text-xs text-amber-600 leading-snug"></p>
      </div>

      <div
        data-wakelock-target="banner"
        class="hidden fixed inset-x-0 bottom-0 bg-amber-500 text-white px-4 flex items-center justify-between shadow-lg z-50"
        style="padding-top: 12px; padding-bottom: max(12px, env(safe-area-inset-bottom));"
      >
        <span class="text-sm font-medium">ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ãŒè§£é™¤ã•ã‚Œã¾ã—ãŸ</span>
        <button
          data-action="click->wakelock#resume"
          class="bg-white text-amber-600 text-xs font-bold px-3 py-1.5 rounded-full ml-3 whitespace-nowrap flex-shrink-0"
        >
          å†é–‹ã™ã‚‹
        </button>
      </div>
      <input
        type="text"
        inputmode="none"
        readonly
        aria-hidden="true"
        tabindex="-1"
        data-count-target="keyCapture"
        style="position:fixed;opacity:0;width:1px;height:1px;left:-9999px;top:0"
      >

      <div
        data-startup-target="overlay"
        class="fixed inset-0 bg-black/50 flex items-end justify-center z-50"
      >
        <div class="bg-white rounded-t-3xl w-full max-w-[390px] px-6 pt-6 flex flex-col items-center gap-4"
          style="padding-bottom: max(24px, env(safe-area-inset-bottom));">
          <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" class="text-[#11409F]">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
          </svg>
          <div class="text-center">
            <p class="text-[#12377E] text-lg font-bold">ã‚¹ã‚¿ãƒ‡ã‚£ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°</p>
            <p class="text-[#496182] text-sm mt-1">ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ã‚’ONã«ã—ã¦å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
          </div>
          <button
            data-action="click->startup#start"
            class="w-full bg-[#18A8E4] text-white text-lg font-bold py-4 rounded-2xl active:scale-95 transition-all select-none"
          >
            ã¯ã˜ã‚ã‚‹
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
   import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js";

   class CountController extends Controller {
     static targets = ["count", "prevCount", "streakDays", "streakSub", "topBadge", "goalBadge", "button", "keyCapture"];
     static STORAGE_KEY = "studySampli";
     static GOAL_KEY = "studySampli_goal";
     static DEFAULT_GOAL = 20;

     #readGoal() {
       const val = parseInt(localStorage.getItem(CountController.GOAL_KEY), 10);
       return isNaN(val) || val < 1 ? CountController.DEFAULT_GOAL : val;
     }

     #writeGoal(val) {
       localStorage.setItem(CountController.GOAL_KEY, String(val));
     }

     #getToday() {
       return new Date().toISOString().slice(0, 10);
     }

     #readStorage() {
       try {
         return JSON.parse(localStorage.getItem(CountController.STORAGE_KEY) || "{}");
       } catch {
         return {};
       }
     }

     #writeStorage(data) {
       localStorage.setItem(CountController.STORAGE_KEY, JSON.stringify(data));
     }

     #calcStreak(data, today) {
       const todayCount = data[today] || 0;
       let streak = 0;

       const startOffset = todayCount > 0 ? 0 : 1;

       for (let i = startOffset; i < 365; i++) {
         const d = new Date();
         d.setDate(d.getDate() - i);
         const key = d.toISOString().slice(0, 10);
         if ((data[key] || 0) > 0) {
           streak++;
         } else {
           break;
         }
       }

       return streak;
     }

     connect() {
       this.render();
       this._bindKeyCapture = () => {
         if (!this.streakSubTarget.querySelector('input')) {
           this.keyCaptureTarget.focus();
         }
       };
       document.addEventListener('touchend', this._bindKeyCapture, { passive: true });
     }

     disconnect() {
       document.removeEventListener('touchend', this._bindKeyCapture);
     }

     push() {
       const data = this.#readStorage();
       const today = this.#getToday();
       const prevKey = Object.keys(data).filter(k => k < today).sort().at(-1);
       const prevCount = prevKey ? data[prevKey] : 0;
       data[today] = (data[today] || 0) + 1;
       this.#writeStorage(data);
       if (prevCount > 0 && data[today] === prevCount + 1) {
         confetti({ particleCount: 120, spread: 80, origin: { y: 0.5 } });
       }
       if (data[today] === this.#readGoal()) {
         confetti({ particleCount: 200, spread: 120, origin: { y: 0.5 }, colors: ['#FFD700', '#FF69B4', '#00CED1', '#7CFC00', '#FF6347'] });
       }
       this.render();
     }

     editGoal() {
       const span = this.streakSubTarget;
       if (span.querySelector('input')) return;

       const goal = this.#readGoal();
       span.textContent = '';

       const label = document.createElement('span');
       label.textContent = 'ç›®æ¨™ ';

       const input = document.createElement('input');
       input.type = 'number';
       input.inputMode = 'numeric';
       input.value = goal;
       input.min = 1;
       input.max = 999;
       input.className = 'w-12 text-xs text-center border-b border-[#496182] bg-transparent outline-none text-[#496182]';

       const unit = document.createElement('span');
       unit.textContent = ' å•';

       span.appendChild(label);
       span.appendChild(input);
       span.appendChild(unit);
       input.focus();
       input.select();

       const commit = () => {
         const val = parseInt(input.value, 10);
         if (!isNaN(val) && val >= 1 && val <= 999) {
           this.#writeGoal(val);
         }
         this.render();
         this.keyCaptureTarget.focus();
       };

       input.addEventListener('blur', commit, { once: true });
       input.addEventListener('keydown', (e) => {
         if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
         if (e.key === 'Escape') { input.removeEventListener('blur', commit); this.render(); }
       });
     }

     render() {
       const data = this.#readStorage();
       const today = this.#getToday();
       const todayCount = data[today] || 0;
       const prevKey = Object.keys(data).filter(k => k < today).sort().at(-1);
       const prevCount = prevKey ? data[prevKey] : 0;
       const streak = this.#calcStreak(data, today);
       const goal = this.#readGoal();
       const remaining = Math.max(0, goal - todayCount);

       this.countTarget.textContent = todayCount;
       this.prevCountTarget.textContent = prevCount;
       this.streakDaysTarget.textContent = `é€£ç¶š ${streak}æ—¥`;
       this.streakSubTarget.textContent =
         remaining === 0 ? "ä»Šæ—¥ã®ç›®æ¨™é”æˆï¼" : `ç›®æ¨™ã¾ã§ã‚ã¨${remaining}å•`;
       const exceeded = prevCount > 0 && todayCount > prevCount;
       const goalReached = remaining === 0;
       this.topBadgeTarget.classList.toggle("hidden", !exceeded);
       this.goalBadgeTarget.classList.toggle("hidden", !goalReached);
       this.buttonTarget.classList.toggle("bg-[#18A8E4]", !exceeded);
       this.buttonTarget.classList.toggle("bg-red-500", exceeded);
     }
   }

   class SoundController extends Controller {
     connect() {
       this.audio = new Audio('./correct.mp3');
     }

     play() {
       this.audio.currentTime = 0;
       this.audio.play();
     }
   }

   const application = Application.start();
   class WakeLockController extends Controller {
     static targets = ["toggle", "knob", "banner", "errorMsg"];

     connect() {
       this.wakeLock = null;
       this.enabled = false;
       this._handleVisibilityChange = this._onVisibilityChange.bind(this);
       document.addEventListener('visibilitychange', this._handleVisibilityChange);
     }

     disconnect() {
       document.removeEventListener('visibilitychange', this._handleVisibilityChange);
       if (this.wakeLock) {
         this.wakeLock.release().catch(() => {});
       }
     }

     async toggle() {
       if (this.enabled) {
         await this._release();
       } else {
         await this._request();
       }
     }

     async resume() {
       this.bannerTarget.classList.add('hidden');
       await this._request();
     }

     async _request() {
       if (!('wakeLock' in navigator)) {
         this._showError('ãŠä½¿ã„ã®ç’°å¢ƒã§ã¯ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢æ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“');
         return;
       }
       try {
         this.wakeLock = await navigator.wakeLock.request('screen');
         this.enabled = true;
         this.errorMsgTarget.classList.add('hidden');
         this.wakeLock.addEventListener('release', () => {
           this.wakeLock = null;
           if (this.enabled) {
             this._showBanner();
           }
           this._updateUI();
         });
         this._updateUI();
       } catch (err) {
         this.enabled = false;
         let msg = 'ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
         if (err.name === 'NotAllowedError') {
           msg = 'ä½é›»åŠ›ãƒ¢ãƒ¼ãƒ‰ã‚’OFFã«ã™ã‚‹ã‹ã€ç”»é¢ã®è‡ªå‹•ãƒ­ãƒƒã‚¯è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„';
         }
         this._showError(msg);
         this._updateUI();
       }
     }

     async _release() {
       this.enabled = false;
       if (this.wakeLock) {
         await this.wakeLock.release().catch(() => {});
         this.wakeLock = null;
       }
       this.bannerTarget.classList.add('hidden');
       this.errorMsgTarget.classList.add('hidden');
       this._updateUI();
     }

     _onVisibilityChange() {
       if (document.visibilityState === 'visible' && this.enabled && !this.wakeLock) {
         this._showBanner();
       }
     }

     _showBanner() {
       this.bannerTarget.classList.remove('hidden');
     }

     _showError(msg) {
       this.errorMsgTarget.textContent = msg;
       this.errorMsgTarget.classList.remove('hidden');
     }

     _updateUI() {
       const isActive = this.enabled && this.wakeLock !== null;
       this.toggleTarget.setAttribute('aria-checked', String(isActive));
       if (isActive) {
         this.toggleTarget.classList.remove('bg-gray-300');
         this.toggleTarget.classList.add('bg-[#18A8E4]');
         this.knobTarget.classList.remove('translate-x-1');
         this.knobTarget.classList.add('translate-x-[28px]');
       } else {
         this.toggleTarget.classList.remove('bg-[#18A8E4]');
         this.toggleTarget.classList.add('bg-gray-300');
         this.knobTarget.classList.remove('translate-x-[28px]');
         this.knobTarget.classList.add('translate-x-1');
       }
     }
   }

   class StartupController extends Controller {
     static targets = ["overlay"];

     async start() {
       this.overlayTarget.classList.add('hidden');

       // focus ã¯ await ã‚ˆã‚Šå‰ã«å‘¼ã¶ï¼ˆiOS ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®åŒæœŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ãªã„ã¨ç„¡è¦–ã™ã‚‹ï¼‰
       const keyCapture = this.element.querySelector('[data-count-target="keyCapture"]');
       if (keyCapture) keyCapture.focus();

       const wl = this.application.getControllerForElementAndIdentifier(this.element, 'wakelock');
       if (wl) await wl._request();
     }
   }

   application.register("count", CountController);
   application.register("sound", SoundController);
   application.register("wakelock", WakeLockController);
   application.register("startup", StartupController);

   if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('./sw.js');
   }
  </script>
</body>
</html>
