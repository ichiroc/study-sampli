<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>スタディサンプリ</title>
  <link rel="icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#11409F">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="サンプリ">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#F4F7FC] flex flex-col">
  <!-- ① ヘッダー -->
  <header class="bg-[#11409F] flex items-center justify-between px-4" style="height: calc(74px + env(safe-area-inset-top)); padding-top: env(safe-area-inset-top);">
    <span class="flex items-center gap-2">
      <span class="text-white text-2xl font-bold">スタディサンプリ</span>
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" class="bi bi-emoji-smile-upside-down" viewBox="0 0 16 16">
        <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1m0-1a8 8 0 1 1 0 16A8 8 0 0 1 8 0"/>
        <path d="M4.285 6.433a.5.5 0 0 0 .683-.183A3.5 3.5 0 0 1 8 4.5c1.295 0 2.426.703 3.032 1.75a.5.5 0 0 0 .866-.5A4.5 4.5 0 0 0 8 3.5a4.5 4.5 0 0 0-3.898 2.25.5.5 0 0 0 .183.683M7 9.5C7 8.672 6.552 8 6 8s-1 .672-1 1.5.448 1.5 1 1.5 1-.672 1-1.5m4 0c0-.828-.448-1.5-1-1.5s-1 .672-1 1.5.448 1.5 1 1.5 1-.672 1-1.5"/>
      </svg>
    </span>
    <span class="text-[#CFE1FF] text-xs font-semibold">学習サポート</span>
  </header>
  <div class="flex-1 flex justify-center">
  <div
    class="w-full max-w-[390px] flex flex-col"
    data-controller="count sound"
    data-action="keydown.enter@window->sound#play keydown.enter@window->count#push"
  >

    <!-- ② ヒーローセクション -->
    <section class="bg-white px-4 pt-[18px] pb-[18px] flex flex-col gap-3">
      <h1 class="text-[#12377E] text-[42px] font-bold leading-[1.12]">正解音で、<br>勉強のリズムを<br>つくろう</h1>
      <p class="text-[#496182] text-lg leading-relaxed">問題が解けたらボタンを押すだけ…</p>

      <!-- フォンモック -->
      <div class="bg-[#0E3388] rounded-2xl h-[170px] flex items-center justify-center">
        <!-- 白カード -->
        <div class="bg-white w-[300px] rounded-xl p-[10px] flex flex-col gap-2">
          <!-- 上バー: 今日の正解 + +N badge -->
          <div class="flex items-center justify-between h-[28px]">
            <span class="text-[#12377E] text-sm font-semibold">今日の正解</span>
            <span
              class="bg-[#11409F] text-white text-xs font-bold px-2 rounded-full h-[28px] flex items-center"
              data-count-target="topBadge"
            >+0</span>
          </div>
          <!-- 行1: 正解カウント + 数値 -->
          <div class="bg-[#DCEEFF] rounded-lg h-[38px] flex items-center justify-between px-3">
            <span class="text-[#12377E] text-sm font-medium">正解カウント</span>
            <span
              class="text-[#D62FC6] text-xl font-bold"
              data-count-target="count"
            >0</span>
          </div>
          <!-- 行2: 連続N日 / 目標まであとN問 + やる気UP badge -->
          <div class="bg-[#F7FAFF] border border-[#D7DEEA] rounded-lg h-[38px] flex items-center justify-between px-3">
            <div class="flex items-center gap-2">
              <span
                class="text-[#12377E] text-sm font-medium"
                data-count-target="streakDays"
              >連続 0日</span>
              <span
                class="text-[#496182] text-xs"
                data-count-target="streakSub"
              >目標まであと20問</span>
            </div>
            <span class="text-[#11409F] text-xs font-semibold">やる気UP</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ③ ツールセクション -->
    <section class="bg-[#EAF4FF] flex-1 flex items-center justify-center" style="min-height: 360px;">
      <button
        data-action="click->sound#play click->count#push"
        class="w-[236px] h-[236px] rounded-full bg-[#18A8E4] text-white text-[58px] font-bold
               active:scale-95 transition-transform select-none shadow-lg"
      >
        正解！
      </button>
    </section>
    <div class="flex justify-center color text-gray-500 text-sm">
      <div>これは個人が作ったジョークアプリです</div>
    </div>
    <!-- Wake Lock デバッグパネル -->
    <div id="wakelock-debug" class="mx-4 my-2 p-3 bg-gray-100 rounded-lg text-xs text-gray-700 font-mono">
      <div class="font-bold text-gray-800 mb-1">Wake Lock デバッグ</div>
      <div>サポート: <span id="wl-supported">確認中...</span></div>
      <div>状態: <span id="wl-state">-</span></div>
      <div>エラー: <span id="wl-error">-</span></div>
      <div>ログ:</div>
      <ul id="wl-log" class="mt-1 space-y-0.5 max-h-32 overflow-y-auto"></ul>
    </div>
  </div>
  </div>

  <script type="module">
    import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js";

    const STORAGE_KEY = "studySampli";
    const DAILY_GOAL = 20;

    function getToday() {
      return new Date().toISOString().slice(0, 10);
    }

    function readStorage() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      } catch {
        return {};
      }
    }

    function writeStorage(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function calcStreak(data, today) {
      const todayCount = data[today] || 0;
      let streak = 0;

      // 今日が0件なら昨日から遡る
      const startOffset = todayCount > 0 ? 0 : 1;

      for (let i = startOffset; i < 365; i++) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const key = d.toISOString().slice(0, 10);
        if ((data[key] || 0) > 0) {
          streak++;
        } else {
          break;
        }
      }

      return streak;
    }

    class CountController extends Controller {
      static targets = ["count", "topBadge", "streakDays", "streakSub"];

      connect() {
        this.render();
      }

      push() {
        const data = readStorage();
        const today = getToday();
        data[today] = (data[today] || 0) + 1;
        writeStorage(data);
        this.render();
      }

      render() {
        const data = readStorage();
        const today = getToday();
        const todayCount = data[today] || 0;
        const streak = calcStreak(data, today);
        const remaining = Math.max(0, DAILY_GOAL - todayCount);

        this.countTarget.textContent = todayCount;
        this.topBadgeTarget.textContent = `+${todayCount}`;
        this.streakDaysTarget.textContent = `連続 ${streak}日`;
        this.streakSubTarget.textContent =
          remaining === 0 ? "今日の目標達成！" : `目標まであと${remaining}問`;
      }
    }

    class SoundController extends Controller {
      connect() {
        this.audio = new Audio('./correct.mp3');
      }

      play() {
        this.audio.currentTime = 0;
        this.audio.play();
      }
    }

    const application = Application.start();
    application.register("count", CountController);
    application.register("sound", SoundController);

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }

    // Screen Wake Lock: 画面が自動ロックされないようにする
    let wakeLock = null;

    const wlSupported = document.getElementById('wl-supported');
    const wlState    = document.getElementById('wl-state');
    const wlError    = document.getElementById('wl-error');
    const wlLog      = document.getElementById('wl-log');

    function wlAddLog(msg) {
      const time = new Date().toLocaleTimeString('ja-JP');
      const li = document.createElement('li');
      li.textContent = `[${time}] ${msg}`;
      wlLog.prepend(li);
    }

    function wlUpdateState() {
      if (wakeLock) {
        wlState.textContent = `取得済み (released=${wakeLock.released})`;
        wlState.style.color = wakeLock.released ? 'orange' : 'green';
      } else {
        wlState.textContent = 'なし';
        wlState.style.color = 'gray';
      }
    }

    if ('wakeLock' in navigator) {
      wlSupported.textContent = 'あり';
      wlSupported.style.color = 'green';
    } else {
      wlSupported.textContent = 'なし (API非対応)';
      wlSupported.style.color = 'red';
    }

    async function requestWakeLock() {
      if (!('wakeLock' in navigator)) {
        wlAddLog('wakeLock API 非対応');
        return;
      }
      try {
        wlAddLog('取得リクエスト中...');
        wakeLock = await navigator.wakeLock.request('screen');
        wlAddLog('取得成功');
        wlError.textContent = '-';
        wlUpdateState();

        wakeLock.addEventListener('release', () => {
          wlAddLog('解除されました');
          wlUpdateState();
        });
      } catch (err) {
        wlAddLog(`取得失敗: ${err.name}: ${err.message}`);
        wlError.textContent = `${err.name}: ${err.message}`;
        wlError.style.color = 'red';
        wlUpdateState();
      }
    }

    requestWakeLock();

    document.addEventListener('visibilitychange', () => {
      wlAddLog(`visibilitychange: ${document.visibilityState}`);
      if (document.visibilityState === 'visible') {
        requestWakeLock();
      }
    });
</script>
</body>
</html>
